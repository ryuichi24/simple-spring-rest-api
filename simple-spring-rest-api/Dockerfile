FROM gradle:jdk18 AS build

ARG BUILD_DIR=/home/build

COPY . ${BUILD_DIR}
WORKDIR ${BUILD_DIR}

ENV SPRING_PROFILES_ACTIVE=prod
RUN gradle build --no-daemon

FROM openjdk:18.0

ARG PORT=5555
ARG SPRING_PROFILES_ACTIVE=prod
ARG DB_CONNECTION_STRING
ARG DB_USER
ARG DB_PASSWORD
ARG DB_DIALECT

ENV PORT=${PORT}
ENV SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
ENV DB_CONNECTION_STRING=${DB_CONNECTION_STRING}
ENV DB_USER=${DB_USER}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV DB_DIALECT=${DB_DIALECT}
ENV HOST=0.0.0.0

EXPOSE 5555

RUN mkdir /app

COPY --from=build "/home/build/build/libs/*.jar" /app/app.jar

ENTRYPOINT ["java", "-jar", "/app/app.jar"]